from starlette.testclient import TestClient
from main import app
from test.setup.setup_data import setup_data_one_ticker
import pytest

client = TestClient(app)

@pytest.fixture
def setup():
    return setup_data_one_ticker()


def test_stock_historical_data_api_returns_200(setup):
    response = client.post('/stockHistorical', json=setup)
    assert response.status_code == 200
    assert response.json() == expected_response

def test_stock_historical_data_api_returns_422_not_data():
    response = client.post('/stockHistorical')
    assert response.status_code == 422





expected_response={'price_history': [{'GS': 55.82, 'date': '1999-05-04'}, {'GS': 57.31, 'date': '1999-06-30'}, {'GS': 48.49, 'date': '1999-09-30'}, {'GS': 73.07, 'date': '2000-01-31'}, {'GS': 83.94, 'date': '2000-03-31'}, {'GS': 75.69, 'date': '2000-06-30'}, {'GS': 91.15, 'date': '2001-01-31'}, {'GS': 70.08, 'date': '2002-01-31'}, {'GS': 53.38, 'date': '2002-09-30'}, {'GS': 55.33, 'date': '2003-01-31'}, {'GS': 55.31, 'date': '2003-03-31'}, {'GS': 68.15, 'date': '2003-06-30'}, {'GS': 68.47, 'date': '2003-09-30'}, {'GS': 85.62, 'date': '2004-03-31'}, {'GS': 77.45, 'date': '2004-06-30'}, {'GS': 76.91, 'date': '2004-09-30'}, {'GS': 89.42, 'date': '2005-01-31'}, {'GS': 91.2, 'date': '2005-03-31'}, {'GS': 84.79, 'date': '2005-06-30'}, {'GS': 101.28, 'date': '2005-09-30'}, {'GS': 118.13, 'date': '2006-01-31'}, {'GS': 131.27, 'date': '2006-03-31'}, {'GS': 126.07, 'date': '2006-06-30'}, {'GS': 178.87, 'date': '2007-01-31'}, {'GS': 169.37, 'date': '2008-01-31'}, {'GS': 140.38, 'date': '2008-03-31'}, {'GS': 148.73, 'date': '2008-06-30'}, {'GS': 109.06, 'date': '2008-09-30'}, {'GS': 91.1, 'date': '2009-03-31'}, {'GS': 127.02, 'date': '2009-06-30'}, {'GS': 159.16, 'date': '2009-09-30'}, {'GS': 147.96, 'date': '2010-03-31'}, {'GS': 114.11, 'date': '2010-06-30'}, {'GS': 126.0, 'date': '2010-09-30'}, {'GS': 142.91, 'date': '2011-01-31'}, {'GS': 138.82, 'date': '2011-03-31'}, {'GS': 116.79, 'date': '2011-06-30'}, {'GS': 83.22, 'date': '2011-09-30'}, {'GS': 98.49, 'date': '2012-01-31'}, {'GS': 132.8, 'date': '2013-01-31'}, {'GS': 143.5, 'date': '2013-09-30'}, {'GS': 149.35, 'date': '2014-01-31'}, {'GS': 149.61, 'date': '2014-03-31'}, {'GS': 153.41, 'date': '2014-06-30'}, {'GS': 168.71, 'date': '2014-09-30'}, {'GS': 173.85, 'date': '2015-03-31'}, {'GS': 193.71, 'date': '2015-06-30'}, {'GS': 161.76, 'date': '2015-09-30'}, {'GS': 147.28, 'date': '2016-03-31'}, {'GS': 139.97, 'date': '2016-06-30'}, {'GS': 152.52, 'date': '2016-09-30'}, {'GS': 217.55, 'date': '2017-01-31'}, {'GS': 218.5, 'date': '2017-03-31'}, {'GS': 211.77, 'date': '2017-06-30'}, {'GS': 257.34, 'date': '2018-01-31'}, {'GS': 192.83, 'date': '2019-01-31'}, {'GS': 204.82, 'date': '2019-09-30'}, {'GS': 236.31, 'date': '2020-01-31'}, {'GS': 138.41, 'date': '2020-03-20'}], 'price_history_normalized': [{'GS': 100.0, 'date': '1999-05-04'}, {'GS': 102.67, 'date': '1999-06-30'}, {'GS': 86.87, 'date': '1999-09-30'}, {'GS': 130.9, 'date': '2000-01-31'}, {'GS': 150.38, 'date': '2000-03-31'}, {'GS': 135.6, 'date': '2000-06-30'}, {'GS': 163.29, 'date': '2001-01-31'}, {'GS': 125.55, 'date': '2002-01-31'}, {'GS': 95.63, 'date': '2002-09-30'}, {'GS': 99.12, 'date': '2003-01-31'}, {'GS': 99.09, 'date': '2003-03-31'}, {'GS': 122.09, 'date': '2003-06-30'}, {'GS': 122.66, 'date': '2003-09-30'}, {'GS': 153.39, 'date': '2004-03-31'}, {'GS': 138.75, 'date': '2004-06-30'}, {'GS': 137.78, 'date': '2004-09-30'}, {'GS': 160.19, 'date': '2005-01-31'}, {'GS': 163.38, 'date': '2005-03-31'}, {'GS': 151.9, 'date': '2005-06-30'}, {'GS': 181.44, 'date': '2005-09-30'}, {'GS': 211.63, 'date': '2006-01-31'}, {'GS': 235.17, 'date': '2006-03-31'}, {'GS': 225.85, 'date': '2006-06-30'}, {'GS': 320.44, 'date': '2007-01-31'}, {'GS': 303.42, 'date': '2008-01-31'}, {'GS': 251.49, 'date': '2008-03-31'}, {'GS': 266.45, 'date': '2008-06-30'}, {'GS': 195.38, 'date': '2008-09-30'}, {'GS': 163.2, 'date': '2009-03-31'}, {'GS': 227.55, 'date': '2009-06-30'}, {'GS': 285.13, 'date': '2009-09-30'}, {'GS': 265.07, 'date': '2010-03-31'}, {'GS': 204.42, 'date': '2010-06-30'}, {'GS': 225.73, 'date': '2010-09-30'}, {'GS': 256.02, 'date': '2011-01-31'}, {'GS': 248.69, 'date': '2011-03-31'}, {'GS': 209.23, 'date': '2011-06-30'}, {'GS': 149.09, 'date': '2011-09-30'}, {'GS': 176.44, 'date': '2012-01-31'}, {'GS': 237.91, 'date': '2013-01-31'}, {'GS': 257.08, 'date': '2013-09-30'}, {'GS': 267.56, 'date': '2014-01-31'}, {'GS': 268.02, 'date': '2014-03-31'}, {'GS': 274.83, 'date': '2014-06-30'}, {'GS': 302.24, 'date': '2014-09-30'}, {'GS': 311.45, 'date': '2015-03-31'}, {'GS': 347.03, 'date': '2015-06-30'}, {'GS': 289.79, 'date': '2015-09-30'}, {'GS': 263.85, 'date': '2016-03-31'}, {'GS': 250.75, 'date': '2016-06-30'}, {'GS': 273.24, 'date': '2016-09-30'}, {'GS': 389.73, 'date': '2017-01-31'}, {'GS': 391.44, 'date': '2017-03-31'}, {'GS': 379.38, 'date': '2017-06-30'}, {'GS': 461.02, 'date': '2018-01-31'}, {'GS': 345.45, 'date': '2019-01-31'}, {'GS': 366.93, 'date': '2019-09-30'}, {'GS': 423.34, 'date': '2020-01-31'}, {'GS': 247.96, 'date': '2020-03-20'}], 'rolling_volatility': [{'GS': 0.2030683541903762, 'date': '1999-07-02'}, {'GS': 0.16865503064633447, 'date': '1999-09-30'}, {'GS': 0.18926536070014366, 'date': '2000-01-31'}, {'GS': 0.24648792407125794, 'date': '2000-03-31'}, {'GS': 0.23075624819828738, 'date': '2000-06-30'}, {'GS': 0.25583802889218976, 'date': '2001-01-31'}, {'GS': 0.1347199848775785, 'date': '2002-01-31'}, {'GS': 0.14369154609589685, 'date': '2002-09-30'}, {'GS': 0.12327517728775739, 'date': '2003-01-31'}, {'GS': 0.13525789917974362, 'date': '2003-03-31'}, {'GS': 0.11377345291679299, 'date': '2003-06-30'}, {'GS': 0.09590373850459516, 'date': '2003-09-30'}, {'GS': 0.09447647827767822, 'date': '2004-03-31'}, {'GS': 0.07110928514267432, 'date': '2004-06-30'}, {'GS': 0.08137313412133228, 'date': '2004-09-30'}, {'GS': 0.06643962124637748, 'date': '2005-01-31'}, {'GS': 0.06347288019195976, 'date': '2005-03-31'}, {'GS': 0.09063091790649756, 'date': '2005-06-30'}, {'GS': 0.06791287097558608, 'date': '2005-09-30'}, {'GS': 0.06603608769934154, 'date': '2006-01-31'}, {'GS': 0.09242716801852557, 'date': '2006-03-31'}, {'GS': 0.13026223461803857, 'date': '2006-06-30'}, {'GS': 0.09236691188346723, 'date': '2007-01-31'}, {'GS': 0.16165130060197136, 'date': '2008-01-31'}, {'GS': 0.24452138980155627, 'date': '2008-03-31'}, {'GS': 0.144106464427782, 'date': '2008-06-30'}, {'GS': 0.35674738371236026, 'date': '2008-09-30'}, {'GS': 0.38722170697918945, 'date': '2009-03-31'}, {'GS': 0.17024131113233026, 'date': '2009-06-30'}, {'GS': 0.09884193656031666, 'date': '2009-09-30'}, {'GS': 0.09330833094822376, 'date': '2010-03-31'}, {'GS': 0.13691638839646883, 'date': '2010-06-30'}, {'GS': 0.09842741874589567, 'date': '2010-09-30'}, {'GS': 0.09206780376803018, 'date': '2011-01-31'}, {'GS': 0.07413955622546359, 'date': '2011-03-31'}, {'GS': 0.08759513509172208, 'date': '2011-06-30'}, {'GS': 0.22482660357266634, 'date': '2011-09-30'}, {'GS': 0.17671298278846698, 'date': '2012-01-31'}, {'GS': 0.09088112821169635, 'date': '2013-01-31'}, {'GS': 0.0839474617613445, 'date': '2013-09-30'}, {'GS': 0.06973557205378406, 'date': '2014-01-31'}, {'GS': 0.07513529996172437, 'date': '2014-03-31'}, {'GS': 0.055775138938542294, 'date': '2014-06-30'}, {'GS': 0.05604532512262643, 'date': '2014-09-30'}, {'GS': 0.08473050321756657, 'date': '2015-03-31'}, {'GS': 0.059859085104011334, 'date': '2015-06-30'}, {'GS': 0.11933227878228515, 'date': '2015-09-30'}, {'GS': 0.12810563248661905, 'date': '2016-03-31'}, {'GS': 0.12283932414177416, 'date': '2016-06-30'}, {'GS': 0.07301824317632426, 'date': '2016-09-30'}, {'GS': 0.09389797639748622, 'date': '2017-01-31'}, {'GS': 0.08193706012624251, 'date': '2017-03-31'}, {'GS': 0.09187980852017295, 'date': '2017-06-30'}, {'GS': 0.07809206077592017, 'date': '2018-01-31'}, {'GS': 0.15391995779797463, 'date': '2019-01-31'}, {'GS': 0.1134191072677992, 'date': '2019-09-30'}, {'GS': 0.08609278703258103, 'date': '2020-01-31'}, {'GS': 0.34585264838108337, 'date': '2020-03-20'}], 'cumulative_returns': [{'GS': -0.017894738692219084, 'date': '1999-05-05'}, {'GS': 0.026342900455469803, 'date': '1999-06-30'}, {'GS': -0.1407746369909158, 'date': '1999-09-30'}, {'GS': 0.2692856576949503, 'date': '2000-01-31'}, {'GS': 0.40797002979726854, 'date': '2000-03-31'}, {'GS': 0.3045138232129001, 'date': '2000-06-30'}, {'GS': 0.49037427301649644, 'date': '2001-01-31'}, {'GS': 0.22750521851996014, 'date': '2002-01-31'}, {'GS': -0.044696084131798736, 'date': '2002-09-30'}, {'GS': -0.008816971198158875, 'date': '2003-01-31'}, {'GS': -0.0091785041015903, 'date': '2003-03-31'}, {'GS': 0.19957893003436503, 'date': '2003-06-30'}, {'GS': 0.20426346502479503, 'date': '2003-09-30'}, {'GS': 0.42778667260862363, 'date': '2004-03-31'}, {'GS': 0.3275003387547016, 'date': '2004-06-30'}, {'GS': 0.32050367896078585, 'date': '2004-09-30'}, {'GS': 0.4712121426976577, 'date': '2005-01-31'}, {'GS': 0.4909226689721093, 'date': '2005-03-31'}, {'GS': 0.4180453832077353, 'date': '2005-06-30'}, {'GS': 0.595756730287689, 'date': '2005-09-30'}, {'GS': 0.7496534848522519, 'date': '2006-01-31'}, {'GS': 0.8551240427071393, 'date': '2006-03-31'}, {'GS': 0.8147050801350013, 'date': '2006-06-30'}, {'GS': 1.1645270568969774, 'date': '2007-01-31'}, {'GS': 1.1099534427948519, 'date': '2008-01-31'}, {'GS': 0.9222208031940973, 'date': '2008-03-31'}, {'GS': 0.9800003534963289, 'date': '2008-06-30'}, {'GS': 0.6697659613897382, 'date': '2008-09-30'}, {'GS': 0.4898255761577345, 'date': '2009-03-31'}, {'GS': 0.8222123262666508, 'date': '2009-06-30'}, {'GS': 1.0477777574505498, 'date': '2009-09-30'}, {'GS': 0.974809738856075, 'date': '2010-03-31'}, {'GS': 0.7150306673384108, 'date': '2010-06-30'}, {'GS': 0.8141496788433003, 'date': '2010-09-30'}, {'GS': 0.9400828333855257, 'date': '2011-01-31'}, {'GS': 0.9110459018032586, 'date': '2011-03-31'}, {'GS': 0.738245222182295, 'date': '2011-06-30'}, {'GS': 0.39935547544661576, 'date': '2011-09-30'}, {'GS': 0.5678227920734318, 'date': '2012-01-31'}, {'GS': 0.8667120089341543, 'date': '2013-01-31'}, {'GS': 0.9442028070914961, 'date': '2013-09-30'}, {'GS': 0.9841603165539412, 'date': '2014-01-31'}, {'GS': 0.9858996801179637, 'date': '2014-03-31'}, {'GS': 1.0109818477485044, 'date': '2014-06-30'}, {'GS': 1.106049036509706, 'date': '2014-09-30'}, {'GS': 1.1360606303456935, 'date': '2015-03-31'}, {'GS': 1.2442299671983088, 'date': '2015-06-30'}, {'GS': 1.0639815271639828, 'date': '2015-09-30'}, {'GS': 0.9702033088166444, 'date': '2016-03-31'}, {'GS': 0.919295885824377, 'date': '2016-06-30'}, {'GS': 1.005163506881186, 'date': '2016-09-30'}, {'GS': 1.3602964810585119, 'date': '2017-01-31'}, {'GS': 1.3646537864274682, 'date': '2017-03-31'}, {'GS': 1.3333685519673137, 'date': '2017-06-30'}, {'GS': 1.5282659396486657, 'date': '2018-01-31'}, {'GS': 1.239676743623336, 'date': '2019-01-31'}, {'GS': 1.2999993165391126, 'date': '2019-09-30'}, {'GS': 1.443012274275164, 'date': '2020-01-31'}, {'GS': 0.9080880668004317, 'date': '2020-03-20'}]}
